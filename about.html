<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل دخول عبر Google - Supabase</title>
  <style>
    body{font-family: Tahoma, Arial, sans-serif;background:#f5f7fb;color:#222;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{width:380px;padding:24px;border-radius:12px;background:#fff;box-shadow:0 6px 24px rgba(20,20,60,.08);text-align:center}
    h1{font-size:20px;margin:0 0 12px}
    p{margin:6px 0 18px;color:#555}
    button{cursor:pointer;padding:10px 14px;border-radius:8px;border:0;font-weight:600}
    .google{background:#fff;border:1px solid #ddd}
    .logout{background:#e74c3c;color:#fff;width:100%}
    .hidden{display:none}
    .profile{display:flex;gap:12px;align-items:center;justify-content:center;margin:12px 0}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    small{display:block;color:#888;margin-top:8px}
    a.config{font-size:12px;color:#3498db;text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>تسجيل الدخول بواسطة Google</h1>
    <p>اضغط الزر لتسجيل الدخول عبر حساب Google باستخدام Supabase (OAuth).</p>
    <button id="btn-google" class="google">🔐 تسجيل الدخول عبر Google</button>

    <div id="user-area" class="hidden">
      <div class="profile">
        <img id="avatar" class="avatar" src="" alt="avatar" />
        <div>
          <div id="user-email" style="font-weight:700"></div>
          <small id="user-name"></small>
        </div>
      </div>
      <button id="btn-logout" class="logout">تسجيل الخروج</button>
      <button id="btn-delete" class="logout" style="background:#c0392b;margin-top:8px">حذف الحساب</button>
    </div>

    <hr style="margin:18px 0" />
    <small>ملاحظة: تأكد من إضافة عنوان التوجيه (Redirect URL) في إعدادات Supabase Authentication ليتوافق مع موقعك.</small>
    <p style="margin-top:8px"><a class="config" target="_blank" href="https://app.supabase.com/project/pbfaysesdyqtxosfajle/auth/settings">فتح إعدادات المصادقة في Supabase</a></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://pbfaysesdyqtxosfajle.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZmF5c2VzZHlxdHhvc2ZhamxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTkwNzIsImV4cCI6MjA3Mzg3NTA3Mn0.frTWR3eGYH6Yh0VVojOwM-vdQfTxDFIKpaMXUDAi2og'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const btnGoogle = document.getElementById('btn-google')
    const btnLogout = document.getElementById('btn-logout')
    const btnDelete = document.getElementById('btn-delete')
    const userArea = document.getElementById('user-area')
    const avatar = document.getElementById('avatar')
    const userEmail = document.getElementById('user-email')
    const userName = document.getElementById('user-name')

    // تسجيل الدخول عبر Google
    btnGoogle.addEventListener('click', async () => {
      const redirectTo = window.location.origin + window.location.pathname
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo }
      })
      if (error) { alert('حدث خطأ: ' + error.message); console.error(error) }
    })

    // تسجيل الخروج
    btnLogout.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut()
      if (error) return alert('خطأ أثناء تسجيل الخروج: ' + error.message)
      updateUI(null)
    })

    // حذف الحساب (يتصل بـ Edge Function)
    btnDelete.addEventListener('click', async () => {
      if (!confirm('هل أنت متأكد من حذف حسابك نهائيًا؟')) return;
      const session = supabase.auth.getSession()
      const user = (await session).data?.session?.user
      if (!user) return alert('لم يتم العثور على المستخدم.')

      try {
        const res = await fetch('https://pbfaysesdyqtxosfajle.supabase.co/functions/v1/delete-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: user.id })
        })
        const result = await res.json()
        if (res.ok) {
          alert('تم حذف الحساب بنجاح.')
          updateUI(null)
        } else {
          alert('خطأ: ' + result.error)
        }
      } catch (err) {
        alert('حدث خطأ: ' + err.message)
      }
    })

    // عند العودة من OAuth
    async function handleRedirect() {
      try {
        const { data, error } = await supabase.auth.getSessionFromUrl({ storeSession: true })
        if (error) console.log('getSessionFromUrl:', error.message)
      } catch (err) { console.warn('handleRedirect:', err) }
    }

    // مراقبة المصادقة
    supabase.auth.onAuthStateChange((event, session) => {
      updateUI(session ? session.user : null)
    })

    // فحص الجلسة عند التحميل
    async function checkSession() {
      const { data: { session }, error } = await supabase.auth.getSession()
      if (error) console.warn('getSession error', error)
      updateUI(session ? session.user : null)
    }

    function updateUI(user) {
      if (user) {
        userArea.classList.remove('hidden')
        btnGoogle.classList.add('hidden')
        avatar.src = user.user_metadata?.avatar_url || user.user_metadata?.picture || 'https://www.gravatar.com/avatar?d=mp'
        userEmail.textContent = user.email || user.user_metadata?.email || ''
        userName.textContent = user.user_metadata?.full_name || user.user_metadata?.name || ''
      } else {
        userArea.classList.add('hidden')
        btnGoogle.classList.remove('hidden')
        avatar.src = ''
        userEmail.textContent = ''
        userName.textContent = ''
      }
    }

    (async () => { await handleRedirect(); await checkSession() })()
  </script>
</body>
</html>
