<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رفع إلى Google Drive</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:28px auto;max-width:760px;padding:12px}
    .card{padding:18px;border-radius:8px;border:1px solid #e3e3e3;background:#fff}
    input[type=file]{display:block;margin:12px 0}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0366d6;color:#fff;cursor:pointer}
    .log{white-space:pre-wrap;margin-top:12px;background:#f9f9f9;padding:12px;border-radius:6px;border:1px solid #eee}
    a.small{font-size:13px;color:#0366d6}
  </style>
</head>
<body>
  <h2>رفع ملف إلى حسابي على Google Drive</h2>
  <div class="card">
    <p>اختر ملف ثم اضغط على <strong>ارفع الملف</strong>. سيتم تخزين الملف داخل مجلدي على Google Drive.</p>

    <input id="fileEl" type="file" />
    <!-- ضع هنا التوكن السري نفسه الموجود في Code.gs -->
    <input id="token" type="text" placeholder="ضع التوكن هنا" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    <div style="margin-top:10px">
      <button id="uploadBtn">ارفع الملف</button>
    </div>

    <div class="log" id="log">جاهز للرفع…</div>
    <p style="margin-top:8px"><a class="small" href="https://script.google.com/macros/s/AKfycbwF4E7Sgm6ZJ56VuF6KzOZ0rzw1HIiIzfs2qZEjEh9WdCbuB0xXthhja_QpDxOqAm5-fw/exec" target="_blank">رابط Web App (اختياري لفتح)</a></p>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwF4E7Sgm6ZJ56VuF6KzOZ0rzw1HIiIzfs2qZEjEh9WdCbuB0xXthhja_QpDxOqAm5-fw/exec";

function log(msg){
  const el = document.getElementById('log');
  el.textContent = msg + "\n\n" + el.textContent;
}

document.getElementById('uploadBtn').addEventListener('click', async () => {
  const f = document.getElementById('fileEl').files[0];
  const token = document.getElementById('token').value.trim();

  if (!f) { alert('اختَر ملفًا أولاً'); return; }
  if (!token) { if(!confirm('لم تدخل توكن. الاستمرار بدون توكن قد يفشل. موافق؟')) return; }

  log('قراءة الملف...');
  const reader = new FileReader();
  reader.onload = async function(e){
    try{
      const dataUrl = e.target.result;
      const comma = dataUrl.indexOf(',');
      const base64 = dataUrl.substring(comma+1);
      const payload = {
        filename: f.name,
        mimeType: f.type || 'application/octet-stream',
        base64: base64,
        token: token
      };

      log('إرسال إلى الخادم...');
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const j = await res.json();
      if (j.ok) {
        log('تم الرفع بنجاح!\nاسم الملف: ' + j.name + '\nرابط: ' + j.url);
        const a = document.createElement('a');
        a.href = j.url;
        a.textContent = 'فتح الملف في Drive';
        a.target = '_blank';
        a.style.display = 'block';
        a.style.marginTop = '8px';
        document.querySelector('.card').appendChild(a);
      } else {
        log('خطأ أثناء الرفع: ' + (j.error || JSON.stringify(j)));
      }
    } catch(err){
      log('حدث خطأ: ' + err);
    }
  };
  reader.readAsDataURL(f);
});
</script>
</body>
</html>
